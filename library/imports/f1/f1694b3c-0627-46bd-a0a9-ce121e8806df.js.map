{"version":3,"sources":["assets\\frame\\scripts\\UI\\Panel\\BaseGamePanel.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uEAAsE;AACtE,gFAA+E;AAC/E,wDAAuD;AACvD,8CAA6C;AAC7C,iEAAgE;AAChE,6DAA4D;AAC5D,2DAA0D;AAC1D,iEAA0E;AAC1E,qDAAoD;AACpD,6CAAwC;AACxC,qCAAoC;AACpC,6CAA4C;AAC5C,oCAAmC;AAE7B,IAAA,KAAwB,EAAE,CAAC,UAAU,EAAnC,OAAO,aAAA,EAAE,QAAQ,cAAkB,CAAC;AAG5C;IAA2C,iCAAM;IAAjD;QAAA,qEAqKC;QAnKW,mBAAa,GAAY,KAAK,CAAC;QAGhC,eAAS,GAAY,IAAI,CAAC;;IAgKrC,CAAC;IA9JG,eAAe;IAEf,6BAAK,GAAL;QACI,IAAI,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;YACtD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;SACrC;QAED,cAAc;QACd,iBAAO,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAClC,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAC3B,IAAI,iBAAO,CAAC,MAAM,IAAI,CAAC,iBAAO,CAAC,QAAQ,EAAE;YACrC,eAAM,CAAC,eAAe,EAAE,CAAC;SAC5B;QACD,iCAAe,CAAC,QAAQ,CAAC,2BAAY,CAAC,qBAAqB,EAAE,KAAK,CAAC,CAAC;QAEpE,IAAI,uBAAU,CAAC,UAAU,EAAE;YACvB,IAAI,CAAC,UAAU,EAAE,CAAC;YAClB,eAAM,CAAC,wBAAwB,EAAE,CAAC;SACrC;aAAM;YACH,IAAI,CAAC,MAAM,EAAE,CAAC;SACjB;IACL,CAAC;IAED,iCAAS,GAAT;QACI,iBAAM,SAAS,WAAE,CAAC;QAClB,eAAM,CAAC,SAAS,EAAE,CAAC;IACvB,CAAC;IAEO,kCAAU,GAAlB;QACI,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;QAC1B,IAAI,qBAAS,CAAC,aAAa,EAAE;YACzB,IAAI,CAAC,QAAQ,EAAE,CAAC;SACnB;aAAM;YACH,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC;SACnB;IACL,CAAC;IAES,gCAAQ,GAAlB;QACI,SAAG,CAAC,IAAI,EAAE,CAAC;QACX,iCAAe,CAAC,YAAY,EAAE,CAAC;QAC/B,6BAAa,CAAC,cAAc,CAAC,6BAAa,CAAC,aAAa,EAAE,CAAC,CAAC;QAC5D,IAAI,CAAC,iBAAO,CAAC,MAAM,IAAI,iBAAO,CAAC,QAAQ,EAAE;YACrC,eAAM,CAAC,gBAAgB,EAAE,CAAC;SAC7B;QAED,IAAI,6BAAa,CAAC,UAAU,CAAC,WAAW,EAAE;YACtC,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,0BAA0B,CAAC,CAAC;SACjD;aAAM;YACH,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,2BAA2B,CAAC,CAAC;SAClD;IACL,CAAC;IAES,sCAAc,GAAxB,UAAyB,QAAkB;QACvC,iCAAe,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QACtC,IAAI,iCAAe,CAAC,QAAQ,CAAC,aAAa,CAAC,UAAU,EAAE;YACnD,IAAI,CAAC,iBAAiB,EAAE,CAAC;SAC5B;aAAM;YACH,eAAM,CAAC,aAAa,EAAE,CAAC;YACvB,eAAM,CAAC,cAAc,EAAE,CAAC;SAC3B;IACL,CAAC;IAES,mCAAW,GAArB,UAAsB,gBAAyB;QAC3C,6BAAa,CAAC,iBAAiB,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC;IAC5D,CAAC;IAES,mCAAW,GAArB,UAAsB,gBAAiC;QAAjC,iCAAA,EAAA,wBAAiC;QACnD,6BAAa,CAAC,iBAAiB,CAAC,KAAK,EAAE,gBAAgB,CAAC,CAAC;IAC7D,CAAC;IAES,gCAAQ,GAAlB;QACI,iCAAe,CAAC,QAAQ,CAAC,aAAa,CAAC,UAAU,GAAG,IAAI,CAAC;QACzD,IAAI,CAAC,iBAAiB,EAAE,CAAC;IAC7B,CAAC;IAES,yCAAiB,GAA3B;QACI,eAAM,CAAC,QAAQ,EAAE,CAAC;QAClB,2BAAY,CAAC,OAAO,EAAE,CAAC;QACvB,IAAI,YAAY,GACZ,6BAAa,CAAC,UAAU,CAAC,QAAQ;YACjC,iCAAe,CAAC,QAAQ,CAAC,aAAa,CAAC,cAAc,GAAG,6BAAa,CAAC,UAAU,CAAC,WAAW,CAAC;QACjG,IAAI,6BAAa,CAAC,UAAU,CAAC,WAAW,EAAE;YACtC,eAAM,CAAC,aAAa,CAAC,YAAY,CAAC,CAAC;SACtC;aAAM;YACH,IAAI,GAAG,GAAG,CAAC,KAAK,6BAAa,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC;YAChE,eAAM,CAAC,YAAY,CAAC,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,GAAG,EAAE,YAAY,CAAC,CAAC;SACvD;IACL,CAAC;IAEO,kCAAU,GAAlB;QACI,IAAI,IAAI,CAAC,aAAa,EAAE;YACpB,EAAE,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;YACjB,IAAI,CAAC,QAAQ,EAAE,CAAC;SACnB;IACL,CAAC;IAES,gCAAQ,GAAlB;QACI,eAAM,CAAC,aAAa,EAAE,CAAC;QACvB,eAAM,CAAC,cAAc,EAAE,CAAC;QAExB,iCAAe,CAAC,MAAM,EAAE,CAAC;QACzB,6BAAa,CAAC,UAAU,EAAE,CAAC;IAC/B,CAAC;IAEO,2CAAmB,GAA3B;QACI,MAAM;QACN,iBAAO,CAAC,QAAQ,CAAC,2BAAY,CAAC,IAAI,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC1E,MAAM;QACN,iCAAe,CAAC,EAAE,CAAC,2BAAY,CAAC,gBAAgB,EAAE,IAAI,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;QAE7E,SAAG,CAAC,oBAAoB,CAAC,2BAAY,CAAC,YAAY,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAE9E,aAAa;QACb,iCAAe,CAAC,EAAE,CAAC,2BAAY,CAAC,iBAAiB,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC,CAAC;IACzF,CAAC;IAEO,8BAAM,GAAd;QAAA,iBA4BC;QA3BG,iBAAO,CAAC,WAAW,CACf,iBAAO,CAAC,YAAY,GAAG,iBAAiB,GAAG,iBAAO,CAAC,YAAY,EAC/D,KAAK,EACL,gCAAgC,EAChC,UAAC,GAAG,EAAE,QAAQ;YACV,IAAI,CAAC,GAAG,EAAE;gBACN,IAAI,aAAa,GAAG,QAAQ,CAAC;gBAC7B,IAAI,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,CAAC,EAAE;oBACnC,OAAO;iBACV;gBACD,IAAI,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;gBAChE,IAAI,OAAO,IAAI,IAAI,EAAE;oBACjB,IAAI,OAAO,CAAC,aAAa,IAAI,uBAAU,CAAC,aAAa,EAAE;wBACnD,6BAAa,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;wBACpC,KAAI,CAAC,UAAU,EAAE,CAAC;qBACrB;yBAAM;wBACH,kBAAkB;wBAClB,iBAAO,CAAC,WAAW,CAAC,kBAAkB,CAAC,CAAC;wBACxC,eAAM,CAAC,cAAc,CAAC,wBAAwB,EAAE,EAAE,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;wBAC9D,OAAO;qBACV;iBACJ;aACJ;iBAAM;aACN;QACL,CAAC,EACD,IAAI,CACP,CAAC;IACN,CAAC;IAED,WAAW;IACH,4CAAoB,GAA5B;QACI,iCAAiC;QACjC,iBAAO,CAAC,QAAQ,EAAE,CAAC;QACnB,OAAO;QACP,6BAAa,CAAC,cAAc,EAAE,CAAC;QAC/B,iBAAO,CAAC,QAAQ,EAAE,CAAC;IACvB,CAAC;IAED,8BAAM,GAAN,UAAO,EAAE;QACL,SAAG,CAAC,MAAM,EAAE,CAAC;IACjB,CAAC;IAnKa,uBAAS,GAAG,eAAe,CAAC;IAI1C;QADC,QAAQ;oDACwB;IALhB,aAAa;QADjC,OAAO;OACa,aAAa,CAqKjC;IAAD,oBAAC;CArKD,AAqKC,CArK0C,eAAM,GAqKhD;kBArKoB,aAAa","file":"","sourceRoot":"/","sourcesContent":["import { ConstValue } from '../../../../game/scripts/Data/ConstValue';\nimport { EditorManager } from '../../../../game/scripts/Manager/EditorManager';\nimport { FrameMsgType } from '../../Data/FrameMsgType';\nimport { NetWork } from '../../Http/NetWork';\nimport { ListenerManager } from '../../Manager/ListenerManager';\nimport { ReportManager } from '../../Manager/ReportManager';\nimport { SoundManager } from '../../Manager/SoundManager';\nimport { SyncData, SyncDataManager } from '../../Manager/SyncDataManager';\nimport { UIManager } from '../../Manager/UIManager';\nimport GameMsg from '../../SDK/GameMsg';\nimport { T2M } from '../../SDK/T2M';\nimport { UIHelp } from '../../Utils/UIHelp';\nimport { BaseUI } from '../BaseUI';\n\nconst { ccclass, property } = cc._decorator;\n\n@ccclass\nexport default class BaseGamePanel extends BaseUI {\n    public static className = 'BaseGamePanel';\n    private _isPanelReady: boolean = false;\n\n    @property\n    public isRresult: boolean = true;\n\n    // onLoad () {}\n\n    start() {\n        if (this.data && this.data.node && this.data.node.parent) {\n            this.data.node.removeFromParent();\n        }\n\n        // 发送GameStart\n        GameMsg.gameStart(this.isRresult);\n        this.addSDKEventListener();\n        if (NetWork.isSync && !NetWork.isMaster) {\n            UIHelp.showRecoverMask();\n        }\n        ListenerManager.dispatch(FrameMsgType.TEACHER_PANEL_LOADING, false);\n\n        if (ConstValue.IS_TEACHER) {\n            this.panelReady();\n            UIHelp.showUploadAndReturnPanel();\n        } else {\n            this.getNet();\n        }\n    }\n\n    onDestroy() {\n        super.onDestroy();\n        UIHelp.closeMask();\n    }\n\n    private panelReady() {\n        this._isPanelReady = true;\n        if (UIManager.isGameShowing) {\n            this.setPanel();\n        } else {\n            cc.game.pause();\n        }\n    }\n\n    protected setPanel() {\n        T2M.init();\n        SyncDataManager.initSyncData();\n        ReportManager.initReportData(EditorManager.getLevelCount());\n        if (!NetWork.isSync || NetWork.isMaster) {\n            UIHelp.closeRecoverMask();\n        }\n\n        if (EditorManager.editorData.isStarCount) {\n            cc.resources.load('prefab/ui/panel/OverTips');\n        } else {\n            cc.resources.load('prefab/ui/panel/StarCount');\n        }\n    }\n\n    protected onRecoveryData(recovery: SyncData) {\n        SyncDataManager.setSyncData(recovery);\n        if (SyncDataManager.syncData.frameSyncData.isGameOver) {\n            this.showGameOverPanel();\n        } else {\n            UIHelp.closeOverTips();\n            UIHelp.closeStarCount();\n        }\n    }\n\n    protected answerRight(isCurLevelFinish: boolean) {\n        ReportManager.reportLevelResult(true, isCurLevelFinish);\n    }\n\n    protected answerWrong(isCurLevelFinish: boolean = false) {\n        ReportManager.reportLevelResult(false, isCurLevelFinish);\n    }\n\n    protected gameOver() {\n        SyncDataManager.syncData.frameSyncData.isGameOver = true;\n        this.showGameOverPanel();\n    }\n\n    protected showGameOverPanel() {\n        UIHelp.showMask();\n        SoundManager.stopAll();\n        let isShowReplay: boolean =\n            EditorManager.editorData.isReplay &&\n            SyncDataManager.syncData.frameSyncData.hasReplayCount < EditorManager.editorData.replayCount;\n        if (EditorManager.editorData.isStarCount) {\n            UIHelp.showStarCount(isShowReplay);\n        } else {\n            let str = 1 === EditorManager.getLevelCount() ? '挑战成功' : '闯关成功';\n            UIHelp.showOverTips(2, '', null, str, isShowReplay);\n        }\n    }\n\n    private onGameShow() {\n        if (this._isPanelReady) {\n            cc.game.resume();\n            this.setPanel();\n        }\n    }\n\n    protected onReplay() {\n        UIHelp.closeOverTips();\n        UIHelp.closeStarCount();\n\n        SyncDataManager.replay();\n        ReportManager.replayGame();\n    }\n\n    private addSDKEventListener() {\n        // 小组课\n        GameMsg.addEvent(FrameMsgType.STOP, this.onSDKMsgStopReceived.bind(this));\n        // 小班课\n        ListenerManager.on(FrameMsgType.ON_RECOVERY_DATA, this.onRecoveryData, this);\n\n        T2M.addSyncEventListener(FrameMsgType.REPLAY_START, this.onReplay.bind(this));\n\n        // 预加载：监听窗口打开\n        ListenerManager.on(FrameMsgType.PRELOAD_GAME_SHOW, this.onGameShow.bind(this), this);\n    }\n\n    private getNet() {\n        NetWork.httpRequest(\n            NetWork.GET_QUESTION + '?courseware_id=' + NetWork.coursewareId,\n            'GET',\n            'application/json;charset=utf-8',\n            (err, response) => {\n                if (!err) {\n                    let response_data = response;\n                    if (Array.isArray(response_data.data)) {\n                        return;\n                    }\n                    let content = JSON.parse(response_data.data.courseware_content);\n                    if (content != null) {\n                        if (content.CoursewareKey == ConstValue.CoursewareKey) {\n                            EditorManager.setData(content.data);\n                            this.panelReady();\n                        } else {\n                            // coursewareKey错误\n                            GameMsg.differntKey('CoursewareKey错误！');\n                            UIHelp.showErrorPanel('CoursewareKey错误,请联系客服！', '', '', '确定');\n                            return;\n                        }\n                    }\n                } else {\n                }\n            },\n            null,\n        );\n    }\n\n    // 游戏结束消息监听\n    private onSDKMsgStopReceived() {\n        //各游戏独立处理  先上报当前作答数据  后发送finish消息\n        GameMsg.gameStop();\n        //新课堂上报\n        ReportManager.reportGameOver();\n        GameMsg.finished();\n    }\n\n    update(dt) {\n        T2M.update();\n    }\n}\n"]}